{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4>Enviar Gabarito - {{ exam.title }}</h4>
                <small>Versão: {{ version.label }} | Data: {{ exam.date }}</small>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">

                    <div class="mb-4">
                        <h5>Dados do Aluno</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="student_name" class="form-label">Nome Completo</label>
                                <input type="text" class="form-control" id="student_name" name="student_name"
                                    value="{{ request.form.get('student_name', '') }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="student_course" class="form-label">Curso</label>
                                <input type="text" class="form-control" id="student_course" name="student_course"
                                    value="{{ request.form.get('student_course', '') }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label"><strong>1. Foto do Gabarito</strong></label>
                        <input type="file" name="gabarito_img" class="form-control" accept="image/*"
                            capture="environment">
                        <div class="form-text">Tire uma foto nítida do seu cartão de respostas.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label"><strong>2. Foto do Cabeçalho</strong></label>
                        <input type="file" name="header_image" class="form-control" accept="image/*"
                            capture="environment">
                        <div class="form-text">Tire uma foto do cabeçalho da prova (Nome, Data, Curso).</div>
                    </div>

                    {% if uploaded_filename %}
                    <input type="hidden" name="uploaded_filename" value="{{ uploaded_filename }}">
                    <div class="mb-4 text-center">
                        <h5>Gabarito Enviado:</h5>
                        <img src="{{ url_for('static', filename='uploads/' + uploaded_filename) }}"
                            class="img-fluid border rounded" style="max-height: 300px;" alt="Gabarito Enviado">
                    </div>
                    {% endif %}

                    {% if uploaded_header_filename %}
                    <input type="hidden" name="uploaded_header_filename" value="{{ uploaded_header_filename }}">
                    <div class="mb-4 text-center">
                        <h5>Cabeçalho Enviado:</h5>
                        <img src="{{ url_for('static', filename='uploads/' + uploaded_header_filename) }}"
                            class="img-fluid border rounded" style="max-height: 150px;" alt="Cabeçalho Enviado">
                    </div>
                    {% endif %}

                    {% if uploaded_filename %}
                    <hr>

                    <div class="mb-4">
                        <label class="form-label"><strong>3. Transcreva suas respostas</strong></label>
                        <p class="text-muted small">Para agilizar a correção, marque abaixo as opções que você escolheu:
                        </p>

                        <div class="row">
                            {% for eq in questions %}
                            <div class="col-md-6 mb-2">
                                <div class="card p-2">
                                    <strong>Questão {{ eq.question_number }}</strong>
                                    <div class="btn-group" role="group">
                                        {% for opt in ['A', 'B', 'C', 'D', 'E'] %}
                                        {% if loop.index <= (eq.question.num_alternatives if
                                            eq.question.num_alternatives else 4) %} <input type="radio"
                                            class="btn-check" name="q_{{ eq.question_number }}"
                                            id="q{{ eq.question_number }}_{{ opt }}" value="{{ opt }}" {% if
                                            detected_answers and detected_answers.get(eq.question_number)==opt
                                            %}checked{% endif %}>
                                            <label class="btn btn-outline-secondary"
                                                for="q{{ eq.question_number }}_{{ opt }}">{{ opt }}</label>
                                            {% endif %}
                                            {% endfor %}
                                    </div>
                                    {% if detected_answers and detected_answers.get(eq.question_number) %}
                                    <span class="badge bg-info text-dark ms-2">Detectado: {{
                                        detected_answers.get(eq.question_number) }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            {% if uploaded_filename %}
                            Confirmar e Corrigir
                            {% else %}
                            Processar Imagens
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}